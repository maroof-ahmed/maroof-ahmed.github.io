"use strict";angular.module("USD$").controller("homeController",["$scope","$http","$filter","$sce",function(e,t,a,r){e.page="Home",app.showProcessing(),$(".active-pill").removeClass("active-pill"),$(".home-pill").addClass("active-pill");var s="http://api.dronestre.am/data";s=r.trustAsResourceUrl(s),e.onDataResponse=function(t){if(console.log("data",t),200==t.status){app.hideProcessing(),e.droneData=t.data.strike.reverse(),e.isDbData&&(e.droneData=t.data.strike.reverse());var r=e.droneData;console.log("dData",r),$.ajax({type:"POST",url:"savedata.php",data:{droneStreamData:JSON.stringify(r)},dataType:"json",success:function(e){console.log("response",e)},error:function(e){console.log("error",e)}}),$("body").animate({scrollTop:$("body").offset().top},1),e.allCountries=[],e.allYears=[],r.forEach(function(t){t.targetText=t.target,t.targetText&&t.targetText.indexOf(";")>=0?(t.targetText=t.targetText.split(";"),t.targetText=t.targetText[0]+" and Others"):r.targetText=r.target,t.names[0]||(t.names=[t.names]),""!=t.names[0]?t.namesArray=t.names[0].split(","):t.namesArray=[],e.allCountries.indexOf(t.country)==-1&&e.allCountries.push(t.country),e.allYears.indexOf(a("date")(t.date,"yyyy"))==-1&&e.allYears.push(a("date")(t.date,"yyyy")),"Maulvi Liaqat"==t.target&&console.log("droneData.targetText ",t)}),e.initialDroneData=e.droneData,console.log("$scope.allCountries",e.allCountries),e.filterByDeaths=function(e){return parseInt(e.deaths_max)?parseInt(e.deaths_max):"Unknown"==e.deaths?-1:parseInt(e.deaths)},e.search={filterDeathsInjuries:9999},e.setFilterVal=function(t){if(this.search.filterCountry)if(""!=this.search.filterCountry){r=a("filter")(e.droneData,this.search.filterCountry);var s=this;r=a("filter")(e.droneData,function(e,t,a){var r=e.country;return r==s.search.filterCountry})}else r=e.droneData;if(""==this.search.filterType)this.hasFilter=!1,r=""!=this.search.filterCountry?r:e.droneData,""==e.sorter,e.search.filterDeathsInjuries=0,this.setPage(1);else{if(this.hasFilter=!0,r=""!=this.search.filterCountry?r:e.droneData,"year"==this.search.filterType&&this.search.filterYear)if(console.log("YEAR?",this.search.filterYear,this.search.filterDeathsInjuries),""!=this.search.filterYear){var s=this;r=a("filter")(r,function(e,t,r){var n=e.date,i=a("date")(n,"yyyy");return parseInt(i)==parseInt(s.search.filterYear)})}else r=""!=this.search.filterCountry?r:e.droneData;if("deaths"==this.search.filterType){var s=this;r=a("filter")(r,function(e,t,a){var r=e.deaths.indexOf("-")!=-1?e.deaths_max:e.deaths;return parseInt(r)>=parseInt(s.search.filterDeathsInjuries)})}if("injuries"==this.search.filterType){var s=this;r=a("filter")(r,function(e,t,a){var r=""!=e.injuries?e.injuries:0;return e.injuries.indexOf("-")!=-1?r=parseInt(e.injuries.split("-").pop()):"Dozens"==r?r=24:"Some"==r?r=7:"Several"==r&&(r=30),parseInt(r)>=parseInt(s.search.filterDeathsInjuries)})}this.setPage(1)}e.summarizeResults(r)},e.summarizeResults=function(t){e.totalStrikes=t.length,e.totalDeaths=0,e.totalInjuries=0,e.totalCiviliansKilled=0,e.totalChildrenKilled=0,t.forEach(function(t,a){var r=""!=t.deaths?t.deaths:"0";r.indexOf("-")!=-1?r=parseInt(r.split("-").pop()):"Unknown"==r&&(r=1),e.totalDeaths+=parseInt(r);var s=""!=t.injuries?t.injuries:"0";s.indexOf("-")!=-1?(s=parseInt(s.split("-").pop()),isNaN(s)&&(s=parseInt(t.injuries.split("-")[0]))):s.indexOf("Unknown")!=-1||s.indexOf("Possibl")!=-1||s.indexOf("Yes")!=-1?n=1:"Dozens"==s?s=24:"Some"==s?s=7:"Several"==s?s=30:s.indexOf("Many")!=-1?n=10:s.indexOf("At least")!=-1&&(s=s.replace("At least"," "),s=s.split(" "),s.forEach(function(e){isNaN(parseInt(e))||(s=parseInt(e))})),e.totalInjuries+=parseInt(s);var n=""!=t.civilians?t.civilians:"0";n.indexOf("-")!=-1?(n=parseInt(n.split("-").pop()),isNaN(n)&&(n=parseInt(t.civilians.split("-")[0]))):n.indexOf("Unknown")!=-1||n.indexOf("Possibl")!=-1||n.indexOf("Yes")!=-1?n=1:n.indexOf("Some")!=-1?n=7:n.indexOf("At least")!=-1?(n=n.replace("At least"," "),n=n.split(" "),n.forEach(function(e){isNaN(parseInt(e))||(n=parseInt(e))})):n.indexOf("Many")!=-1?n=10:isNaN(n)&&console.log("civilians",n),e.totalCiviliansKilled+=parseInt(n);var i=""!=t.children?t.children:"0";i.indexOf("-")!=-1?(i=parseInt(i.split("-").pop()),isNaN(i)&&(i=parseInt(t.children.split("-")[0]))):i.indexOf("Unknown")!=-1||i.indexOf("Possibl")!=-1||i.indexOf("Yes")!=-1?i=1:i.indexOf("At least")!=-1?(i=i.replace("At least"," "),i=i.split(" "),i.forEach(function(e){isNaN(parseInt(e))||(i=parseInt(e))})):isNaN(i)&&console.log("children",i),e.totalChildrenKilled+=parseInt(i)})},e.summarizeResults(r),e.sortByDeaths=function(e){return parseInt(e.deaths_max)?parseInt(e.deaths_max):"Unknown"==e.deaths?-1:parseInt(e.deaths)},e.sortByInjuries=function(e){return e.injuries?e.injuries.indexOf("-")!=-1?parseInt(e.injuries.split("-").pop()):"Dozens"==e.injuries?24:"Some"==e.injuries?7:"Several"==e.injuries?30:parseInt(e.injuries):0},e.setSort=function(){""==e.sorter&&(r=e.initialDroneData),"latest"==e.sorter&&(r=a("orderBy")(r,"date",!0)),"oldest"==e.sorter&&(r=a("orderBy")(r,"date")),"country"==e.sorter&&(r=a("orderBy")(r,"country")),"max_deaths"==e.sorter&&(r=a("orderBy")(r,e.sortByDeaths,!0)),"min_deaths"==e.sorter&&(r=a("orderBy")(r,e.sortByDeaths)),"max_injuries"==e.sorter&&(r=a("orderBy")(r,e.sortByInjuries,!0)),"min_injuries"==e.sorter&&(r=a("orderBy")(r,e.sortByInjuries)),e.setPage(1)},e.pagedDroneData=[],e.totalItems=r.length,e.currentPage=1,e.maxSize=5,e.itemsPerPage=20;var s=(e.currentPage-1)*e.itemsPerPage,n=s+e.itemsPerPage;e.sorter="latest","latest"==e.sorter&&(e.pagedDroneData=r.slice(s,n)),e.setPage=function(t){e.currentPage=t,e.pageChanged(),console.log("filtered",r)},e.pageChanged=function(){e.totalItems=r.length,app.showProcessing(),console.log("Page changed to: "+e.currentPage);var t=(e.currentPage-1)*e.itemsPerPage,a=t+e.itemsPerPage;e.pagedDroneData=r.slice(t,a),$("body").animate({scrollTop:$("body").offset().top},1400),app.hideProcessing()},$(document).ready(function(){$(".data-Item").on("mouseover",function(e){$(".image",this).addClass("animate-top")}),$(".data-Item").on("mouseout",function(){$(".image",this).removeClass("animate-top")})})}},$.ajax({type:"POST",url:"getdata.php",dataType:"json",data:{dbData:!0},success:function(a){console.log("Get DB Data Response",a),a.data.strike.length>0?(e.isDbData=!0,e.onDataResponse(a),e.$apply(),console.log("Showing DB Data",a)):t({method:"jsonp",url:s}).then(e.onDataResponse,function(e){app.hideProcessing(),alert("Error in Requesting Data"),console.log("Error in Requesting Data",e)})},error:function(a){console.log("Get DB Data Error",a,a.responseText),t({method:"jsonp",url:s}).then(e.onDataResponse,function(e){app.hideProcessing(),alert("Error in Requesting Data"),console.log("Error in Requesting Data",e)})}})}]);