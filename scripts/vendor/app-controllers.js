"use strict";angular.module("USD$").controller("homeController",["$scope","$http","$filter","$sce",function(e,t,r,a){e.page="Home",app.showProcessing(),$(".active-pill").removeClass("active-pill"),$(".home-pill").addClass("active-pill");var i="http://api.dronestre.am/data";i=a.trustAsResourceUrl(i),e.onDataResponse=function(t){if(console.log("data",t),200==t.status){app.hideProcessing(),e.droneData=t.data.strike.reverse(),e.droneData.forEach(function(e){"Pakistan-Afghanistan Border"==e.country&&(e.country="Pakistan")}),e.isDbData&&(e.droneData=t.data.strike.reverse());var a=e.droneData;console.log("dData",a),$.ajax({type:"POST",url:"savedata.php",data:{droneStreamData:JSON.stringify(a)},dataType:"json",success:function(e){console.log("response",e)},error:function(e){console.log("error",e)}}),$("body").animate({scrollTop:$("body").offset().top},1),e.allCountries=[],e.allYears=[],a.forEach(function(t){t.targetText=t.target,t.targetText&&t.targetText.indexOf(";")>=0?(t.targetText=t.targetText.split(";"),t.targetText=t.targetText[0]+" and Others"):a.targetText=a.target,t.names[0]||(t.names=[t.names]),""!=t.names[0]?t.namesArray=t.names[0].split(","):t.namesArray=[],e.allCountries.indexOf(t.country)==-1&&e.allCountries.push(t.country),e.allYears.indexOf(r("date")(t.date,"yyyy"))==-1&&e.allYears.push(r("date")(t.date,"yyyy")),"Maulvi Liaqat"==t.target&&console.log("droneData.targetText ",t)}),e.initialDroneData=e.droneData,console.log("$scope.allCountries",e.allCountries),e.filterByDeaths=function(e){return parseInt(e.deaths_max)?parseInt(e.deaths_max):"Unknown"==e.deaths?-1:parseInt(e.deaths)},e.sortByDeaths=function(e){return parseInt(e.deaths_max)?parseInt(e.deaths_max):"Unknown"==e.deaths?0:parseInt(e.deaths)},e.sortByInjuries=function(e){var t=""!=e.injuries?e.injuries:"0";return t.indexOf("-")!=-1?(t=parseInt(t.split("-").pop()),isNaN(t)&&(t=parseInt(e.injuries.split("-")[0]))):t.indexOf("Unknown")!=-1||t.indexOf("Possibl")!=-1||t.indexOf("Yes")!=-1?civilians=1:"Dozens"==t?t=24:"Some"==t?t=7:"Several"==t?t=30:t.indexOf("Many")!=-1?civilians=10:t.indexOf("At least")!=-1&&(t=t.replace("At least"," "),t=t.split(" "),t.forEach(function(e){isNaN(parseInt(e))||(t=parseInt(e))})),parseInt(t)},e.sortByCivilianDeaths=function(e){var t=""!=e.civilians?e.civilians:"0";return t.indexOf("-")!=-1?(t=parseInt(t.split("-").pop()),isNaN(t)&&(t=parseInt(e.civilians.split("-")[0]))):t.indexOf("Unknown")!=-1||t.indexOf("Possibl")!=-1||t.indexOf("Yes")!=-1?t=1:t.indexOf("Some")!=-1?t=7:t.indexOf("At least")!=-1?(t=t.replace("At least"," "),t=t.split(" "),t.forEach(function(e){isNaN(parseInt(e))||(t=parseInt(e))})):t.indexOf("Many")!=-1?t=10:isNaN(t)&&console.log("civilians",t),parseInt(t)},e.sortByChildDeaths=function(e){var t=""!=e.children?e.children:"0";return t.indexOf("-")!=-1?(t=parseInt(t.split("-").pop()),isNaN(t)&&(t=parseInt(e.children.split("-")[0]))):t.indexOf("Unknown")!=-1||t.indexOf("Possibl")!=-1||t.indexOf("Yes")!=-1?t=1:t.indexOf("At least")!=-1?(t=t.replace("At least"," "),t=t.split(" "),t.forEach(function(e){isNaN(parseInt(e))||(t=parseInt(e))})):isNaN(t)&&console.log("children",t),parseInt(t)},e.resetFromTo=function(){e.search.filterFromMonth="",e.search.filterToMonth="",e.search.filterFromYear="",e.search.filterToYear=""},e.search={filterDeathsInjuries:9999},e.setFilterVal=function(t){if(this.search.filterCountry)if(""!=this.search.filterCountry){a=r("filter")(e.droneData,this.search.filterCountry);var i=this;a=r("filter")(e.droneData,function(e,t,r){var a=e.country;return a==i.search.filterCountry})}else a=e.droneData;if(""==this.search.filterType)this.hasFilter=!1,a=""!=this.search.filterCountry?a:e.droneData,""==e.sorter,e.search.filterDeathsInjuries=0,this.setPage(1);else{if(this.hasFilter=!0,a=""!=this.search.filterCountry?a:e.droneData,"year"==this.search.filterType&&this.search.filterYear)if(""!=this.search.filterYear){var i=this;a=r("filter")(a,function(e,t,a){var s=e.date;if(""!=i.search.filterMonth){var n=r("date")(s,"MMMM");console.log("month",n)}var o=r("date")(s,"yyyy");return""!=i.search.filterMonth?n==i.search.filterMonth&&parseInt(o)==parseInt(i.search.filterYear):parseInt(o)==parseInt(i.search.filterYear)})}else a=""!=this.search.filterCountry?a:e.droneData;if("from_to"==this.search.filterType){var i=this;a=""!=this.search.filterFromYear&&""!=this.search.filterToYear?r("filter")(a,function(e,t,a){var s=e.date;if(""!=i.search.filterFromMonth&&""!=i.search.filterToMonth){var n=r("date")(s,"M");console.log("month",n)}var o=r("date")(s,"yyyy");return""!=i.search.filterFromMonth&&""!=i.search.filterToMonth?parseInt(n)>=parseInt(i.search.filterFromMonth)&&parseInt(o)>=parseInt(i.search.filterFromYear)&&parseInt(n)<=parseInt(i.search.filterToMonth)&&parseInt(o)<=parseInt(i.search.filterToYear):parseInt(o)>=parseInt(i.search.filterFromYear)&&parseInt(o)<=parseInt(i.search.filterToYear)}):""!=this.search.filterCountry?a:e.droneData}if("deaths"==this.search.filterType){var i=this;a=r("filter")(a,function(e,t,r){var a=e.deaths.indexOf("-")!=-1?e.deaths_max:e.deaths;return parseInt(a)>=parseInt(i.search.filterDeathsInjuries)})}if("injuries"==this.search.filterType){var i=this;a=r("filter")(a,function(e,t,r){var a=""!=e.injuries?e.injuries:0;return e.injuries.indexOf("-")!=-1?a=parseInt(e.injuries.split("-").pop()):"Dozens"==a?a=24:"Some"==a?a=7:"Several"==a&&(a=30),parseInt(a)>=parseInt(i.search.filterDeathsInjuries)})}this.setPage(1)}e.summarizeResults(a)},e.summarizeResults=function(t){0!=t.length&&(e.totalStrikes=t.length,e.totalDeaths=0,e.totalInjuries=0,e.totalCiviliansKilled=0,e.totalChildrenKilled=0,e.lastStrikeDate=r("orderBy")(t,"date",!0)[0].date,e.previousStrikeDate=r("orderBy")(t,"date",!0)[1].date?r("orderBy")(t,"date",!0)[1].date:"",e.firstStrikeDate=r("orderBy")(t,"date")[0].date,e.maximumDeaths=r("orderBy")(t,e.sortByDeaths,!0)[0].deaths,e.minimumDeaths=r("orderBy")(t,e.sortByDeaths)[0].deaths,e.maximumInjuries=r("orderBy")(t,e.sortByInjuries,!0)[0].injuries,""==e.maximumInjuries&&(e.maximumInjuries=0),e.minimumInjuries=r("orderBy")(t,e.sortByInjuries)[0].injuries,""==e.minimumInjuries&&(e.minimumInjuries=0),e.maximumCiviliansKilled=r("orderBy")(t,e.sortByCivilianDeaths,!0)[0].civilians,""==e.maximumCiviliansKilled&&(e.maximumCiviliansKilled=0),e.minimumCiviliansKilled=r("orderBy")(t,e.sortByCivilianDeaths)[0].civilians,""==e.minimumCiviliansKilled&&(e.minimumCiviliansKilled=0),e.maximumChildrenKilled=r("orderBy")(t,e.sortByChildDeaths,!0)[0].children,""==e.maximumChildrenKilled&&(e.maximumChildrenKilled=0),e.minimumChildrenKilled=r("orderBy")(t,e.sortByChildDeaths)[0].children,""==e.minimumChildrenKilled&&(e.minimumChildrenKilled=0),console.log("max min injuries",e.maximumInjuries,e.minimumInjuries),t.forEach(function(t,r){var a=""!=t.deaths?t.deaths:"0";a.indexOf("-")!=-1?a=parseInt(a.split("-").pop()):"Unknown"==a&&(a=1),e.totalDeaths+=parseInt(a);var i=""!=t.injuries?t.injuries:"0";i.indexOf("-")!=-1?(i=parseInt(i.split("-").pop()),isNaN(i)&&(i=parseInt(t.injuries.split("-")[0]))):i.indexOf("Unknown")!=-1||i.indexOf("Possibl")!=-1||i.indexOf("Yes")!=-1?s=1:"Dozens"==i?i=24:"Some"==i?i=7:"Several"==i?i=30:i.indexOf("Many")!=-1?s=10:i.indexOf("At least")!=-1&&(i=i.replace("At least"," "),i=i.split(" "),i.forEach(function(e){isNaN(parseInt(e))||(i=parseInt(e))})),e.totalInjuries+=parseInt(i);var s=""!=t.civilians?t.civilians:"0";s.indexOf("-")!=-1?(s=parseInt(s.split("-").pop()),isNaN(s)&&(s=parseInt(t.civilians.split("-")[0]))):s.indexOf("Unknown")!=-1||s.indexOf("Possibl")!=-1||s.indexOf("Yes")!=-1?s=1:s.indexOf("Some")!=-1?s=7:s.indexOf("At least")!=-1?(s=s.replace("At least"," "),s=s.split(" "),s.forEach(function(e){isNaN(parseInt(e))||(s=parseInt(e))})):s.indexOf("Many")!=-1?s=10:isNaN(s)&&console.log("civilians",s),e.totalCiviliansKilled+=parseInt(s);var n=""!=t.children?t.children:"0";n.indexOf("-")!=-1?(n=parseInt(n.split("-").pop()),isNaN(n)&&(n=parseInt(t.children.split("-")[0]))):n.indexOf("Unknown")!=-1||n.indexOf("Possibl")!=-1||n.indexOf("Yes")!=-1?n=1:n.indexOf("At least")!=-1?(n=n.replace("At least"," "),n=n.split(" "),n.forEach(function(e){isNaN(parseInt(e))||(n=parseInt(e))})):isNaN(n)&&console.log("children",n),e.totalChildrenKilled+=parseInt(n)}))},e.summarizeResults(a),e.setSort=function(){""==e.sorter&&(a=e.initialDroneData),"latest"==e.sorter&&(a=r("orderBy")(a,"date",!0)),"oldest"==e.sorter&&(a=r("orderBy")(a,"date")),"country"==e.sorter&&(a=r("orderBy")(a,"country")),"max_deaths"==e.sorter&&(a=r("orderBy")(a,e.sortByDeaths,!0)),"min_deaths"==e.sorter&&(a=r("orderBy")(a,e.sortByDeaths)),"max_injuries"==e.sorter&&(a=r("orderBy")(a,e.sortByInjuries,!0)),"min_injuries"==e.sorter&&(a=r("orderBy")(a,e.sortByInjuries)),"max_civilian_deaths"==e.sorter&&(a=r("orderBy")(a,e.sortByCivilianDeaths,!0)),"min_civilian_deaths"==e.sorter&&(a=r("orderBy")(a,e.sortByCivilianDeaths)),"max_child_deaths"==e.sorter&&(a=r("orderBy")(a,e.sortByChildDeaths,!0)),"min_child_deaths"==e.sorter&&(a=r("orderBy")(a,e.sortByChildDeaths)),e.setPage(1)},e.pagedDroneData=[],e.totalItems=a.length,e.currentPage=1,e.maxSize=5,e.itemsPerPage=20;var i=(e.currentPage-1)*e.itemsPerPage,s=i+e.itemsPerPage;e.sorter="latest","latest"==e.sorter&&(e.pagedDroneData=a.slice(i,s)),e.setPage=function(t){e.currentPage=t,e.pageChanged(),console.log("filtered",a)},e.pageChanged=function(){e.totalItems=a.length,app.showProcessing(),console.log("Page changed to: "+e.currentPage);var t=(e.currentPage-1)*e.itemsPerPage,r=t+e.itemsPerPage;e.pagedDroneData=a.slice(t,r),$("body").animate({scrollTop:$("body").offset().top},1400),app.hideProcessing()},$(document).ready(function(){$(".data-Item").on("mouseover",function(e){$(".image",this).addClass("animate-top")}),$(".data-Item").on("mouseout",function(){$(".image",this).removeClass("animate-top")})})}},$.ajax({type:"POST",url:"getdata.php",dataType:"json",data:{dbData:!0},success:function(r){console.log("Get DB Data Response",r),r.data.strike.length>0?(e.isDbData=!0,e.onDataResponse(r),e.$apply(),console.log("Showing DB Data",r)):t({method:"jsonp",url:i}).then(e.onDataResponse,function(e){app.hideProcessing(),alert("Error in Requesting Data"),console.log("Error in Requesting Data",e)})},error:function(r){console.log("Get DB Data Error",r,r.responseText),t({method:"jsonp",url:i}).then(e.onDataResponse,function(e){app.hideProcessing(),alert("Error in Requesting Data"),console.log("Error in Requesting Data",e)})}})}]);